<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_invoice_document_fp_template_router" inherit_id="account.report_invoice_document">
        <xpath expr="//t[@t-call='web.external_layout']" position="before">
            <t t-if="o.fp_is_electronic_invoice and o.company_id.fp_invoice_template_style" t-call="factura_profesional_integration.report_invoice_document_fp_custom" t-lang="lang"/>
        </xpath>
        <xpath expr="//t[@t-call='web.external_layout']" position="attributes">
            <attribute name="t-if">not (o.fp_is_electronic_invoice and o.company_id.fp_invoice_template_style)</attribute>
        </xpath>
    </template>

    <template id="report_invoice_document_fp_custom">
        <t t-call="web.external_layout">
            <t t-set="fp_template_style" t-value="o.company_id.fp_invoice_template_style"/>
            <t t-set="fp_document_types" t-value="{
                'FE': 'Factura Electrónica',
                'TE': 'Tiquete Electrónico',
                'FEE': 'Factura Electrónica de Exportación',
                'FEC': 'Factura Electrónica de Compra',
                'NC': 'Nota de Crédito Electrónica',
                'ND': 'Nota de Débito Electrónica',
                'CCE': 'Confirmación de Aceptación',
                'CPCE': 'Confirmación Parcial de Aceptación',
                'RCE': 'Confirmación de Rechazo'
            }"/>

            <div class="page">
                <style>
                    .fp-modern-header {
                        background: linear-gradient(135deg, #102a74, #2144c0 58%, #3969f5);
                        border-radius: 18px;
                        color: #ffffff;
                        margin: 8px 0 12px 0;
                        overflow: hidden;
                    }
                    .fp-modern-header--dark {
                        background: linear-gradient(135deg, #0b1220, #1f2937 58%, #374151);
                    }
                    .fp-modern-header--clean {
                        background: linear-gradient(135deg, #ffffff, #f1f5f9 58%, #e2e8f0);
                        color: #0f172a;
                        border: 1px solid #dbe4ff;
                    }
                    .fp-modern-header--emerald {
                        background: linear-gradient(135deg, #064e3b, #047857 58%, #10b981);
                    }
                    .fp-modern-header--sunset {
                        background: linear-gradient(135deg, #7c2d12, #ea580c 58%, #fb923c);
                    }
                    .fp-modern-header--clean .fp-modern-subtitle {
                        color: #334155;
                        opacity: 1;
                    }
                    .fp-modern-header td {
                        vertical-align: top;
                        padding: 16px;
                    }
                    .fp-modern-company-name {
                        font-size: 24px;
                        font-weight: 700;
                        line-height: 1.2;
                        margin-bottom: 10px;
                    }
                    .fp-modern-line {
                        margin-bottom: 4px;
                        font-size: 13px;
                    }
                    .fp-modern-line strong {
                        font-weight: 700;
                    }
                    .fp-modern-subtitle {
                        opacity: 0.9;
                        font-size: 13px;
                        letter-spacing: 0.6px;
                        text-transform: uppercase;
                        margin-bottom: 8px;
                    }
                    .fp-reference-line {
                        font-size: 15px;
                        margin-bottom: 2px;
                        color: #141d2e;
                    }
                    .fp-reference-line .fp-label-inline {
                        font-weight: 700;
                    }
                    .fp-section-title {
                        font-size: 16px;
                        font-weight: 700;
                        margin: 8px 0 4px 0;
                        color: #111827;
                    }
                    .fp-card {
                        border: 2px solid #1b2c96;
                        border-radius: 18px;
                        padding: 12px 14px;
                        margin: 8px 0;
                        background: #f8faff;
                        width: 100%;
                    }
                    .fp-grid {
                        width: 100%;
                        border-collapse: separate;
                        border-spacing: 0;
                        table-layout: fixed;
                        border: 0 !important;
                        outline: 0 !important;
                        background: transparent;
                    }
                    .fp-grid tbody,
                    .fp-grid tr,
                    .fp-grid td {
                        border: 0 !important;
                        outline: 0 !important;
                        box-shadow: none !important;
                    }
                    .fp-grid-cell {
                        vertical-align: top;
                        font-size: 15px;
                        color: #111827;
                        padding: 6px 10px 6px 0;
                        border-left: 0 !important;
                    }
                    .fp-label {
                        display: inline-block;
                        font-weight: 700;
                        min-width: 128px;
                        color: #1f2a44;
                        margin-right: 4px;
                    }
                    .fp-client-card {
                        border-color: #3b82f6;
                        background: #f8fbff;
                    }
                    .fp-lines-table {
                        margin-top: 12px;
                        border: 1px solid #dbe4ff;
                        border-radius: 14px;
                        overflow: hidden;
                    }
                    .fp-lines-table table {
                        width: 100%;
                        border-collapse: collapse;
                    }
                    .fp-lines-table thead th {
                        background: #f0f4ff;
                        color: #1f2a44;
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.4px;
                        border-bottom: 1px solid #dbe4ff;
                        padding: 8px;
                    }
                    .fp-lines-table tbody td {
                        font-size: 12px;
                        border-bottom: 1px solid #edf1ff;
                        padding: 8px;
                        color: #1f2937;
                    }
                    .fp-lines-table tbody tr:last-child td {
                        border-bottom: 0;
                    }
                    .fp-totals {
                        width: 45%;
                        margin-left: auto;
                        margin-top: 14px;
                        font-size: 13px;
                    }
                    .fp-totals td {
                        padding: 4px 0;
                    }
                    .fp-totals .fp-total-label {
                        font-weight: 700;
                        color: #1f2a44;
                    }
                    .fp-totals .fp-total-grand {
                        border-top: 1px solid #dbe4ff;
                        font-size: 15px;
                    }
                </style>

                <table t-attf-class="fp-modern-header #{'fp-modern-header--dark' if fp_template_style == 'modern_dark' else ('fp-modern-header--clean' if fp_template_style == 'modern_clean' else ('fp-modern-header--emerald' if fp_template_style == 'modern_emerald' else ('fp-modern-header--sunset' if fp_template_style == 'modern_sunset' else '')))}" style="width: 100%;">
                    <tr>
                        <td style="width: 60%;">
                            <div class="fp-modern-company-name" t-esc="o.company_id.name or ''"/>
                            <div class="fp-modern-line"><strong>Identificación:</strong> <span t-esc="o.company_id.vat or ''"/></div>
                            <div class="fp-modern-line"><strong>Correo electrónico:</strong> <span t-esc="o.company_id.email or ''"/></div>
                            <div class="fp-modern-line"><strong>Teléfono:</strong> <span t-esc="o.company_id.phone or ''"/></div>
                        </td>
                        <td t-att-style="'width: 40%; background: rgba(255,255,255,0.12);' if fp_template_style != 'modern_clean' else 'width: 40%; background: rgba(15,23,42,0.06);'">
                            <div class="fp-modern-subtitle" t-esc="fp_document_types.get(o.fp_document_type, 'Comprobante Electrónico')"/>
                            <div style="font-size: 22px; font-weight: 700; margin-bottom: 8px;" t-esc="o.fp_document_type or 'FE'"/>
                            <div class="fp-modern-line"><strong>Consecutivo:</strong> <span t-field="o.fp_consecutive_number"/></div>
                            <div class="fp-modern-line"><strong>Clave:</strong> <span t-field="o.fp_external_id"/></div>
                        </td>
                    </tr>
                </table>

                <div class="fp-card">
                    <table class="fp-grid">
                        <tbody>
                            <tr>
                                <td class="fp-grid-cell" style="width:33.33%;">
                                    <div><span class="fp-label">Fecha:</span><span t-field="o.invoice_date"/></div>
                                    <div><span class="fp-label">Vencimiento:</span><span t-field="o.invoice_date_due"/></div>
                                </td>
                                <td class="fp-grid-cell" style="width:33.33%;">
                                    <div><span class="fp-label">Condición:</span><span t-field="o.fp_sale_condition"/></div>
                                    <div><span class="fp-label">Pago:</span><span t-field="o.fp_payment_method"/></div>
                                </td>
                                <td class="fp-grid-cell" style="width:33.33%; padding-right: 0;">
                                    <div><span class="fp-label">Moneda:</span><span t-field="o.currency_id"/></div>
                                    <div><span class="fp-label">Tipo de cambio:</span><span t-esc="'%.6f' % (o.invoice_currency_rate or 1.0)"/></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="fp-section-title">Datos del receptor:</div>
                <div class="fp-card fp-client-card">
                    <div><span class="fp-label">Cliente:</span><span t-esc="o.partner_id.name or ''"/></div>
                    <div t-if="o.partner_id.vat"><span class="fp-label">Identificación:</span><span t-esc="o.partner_id.vat"/></div>
                    <div t-if="o.partner_id.email"><span class="fp-label">Correo:</span><span t-esc="o.partner_id.email"/></div>
                </div>

                <div class="fp-lines-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 13%;">Cabys</th>
                                <th style="width: 31%;">Detalle</th>
                                <th class="text-end" style="width: 10%;">Cantidad</th>
                                <th class="text-end" style="width: 16%;">Precio unitario</th>
                                <th class="text-end" style="width: 15%;">Impuesto</th>
                                <th class="text-end" style="width: 15%;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="o.invoice_line_ids.filtered(lambda l: not l.display_type)" t-as="line">
                                <td t-esc="line.product_id.fp_cabys_code or '-'"/>
                                <td><span t-field="line.name"/></td>
                                <td class="text-end" t-esc="line.quantity"/>
                                <td class="text-end"><span t-field="line.price_unit" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></td>
                                <td class="text-end"><span t-esc="sum([tax.get('amount', 0.0) for tax in (line.tax_ids.compute_all(line.price_unit, currency=o.currency_id, quantity=line.quantity, product=line.product_id, partner=o.partner_id).get('taxes') or [])])"/></td>
                                <td class="text-end"><span t-field="line.price_subtotal" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <table class="fp-totals">
                    <tr>
                        <td class="fp-total-label">Subtotal</td>
                        <td class="text-end"><span t-field="o.amount_untaxed" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></td>
                    </tr>
                    <tr>
                        <td class="fp-total-label">Impuestos</td>
                        <td class="text-end"><span t-field="o.amount_tax" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></td>
                    </tr>
                    <tr class="fp-total-grand">
                        <td class="fp-total-label">Total</td>
                        <td class="text-end"><strong><span t-field="o.amount_total" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></strong></td>
                    </tr>
                </table>

                <div class="mt-4 text-muted text-center" style="font-size: 11px;">
                    Emitida conforme lo establecido en la resolución de Facturación Electrónica,
                    MH-DGT-RES-0027-2024 del 19 de noviembre de 2024 de la Dirección General de Tributación Directa.
                </div>
                <div class="text-muted text-center" style="font-size: 11px;">Versión del documento 4.4.</div>
            </div>
        </t>
    </template>
</odoo>
